#! /bin/sh

[ -z "$PATH_OVERRIDE" ] || PATH="$PATH_OVERRIDE"

cd S
. "$B_SCRIPTS_D/git/reset"
. "$B_SCRIPTS_D/download/opengl-extension-headers"

. "$B_SCRIPTS_D/patches/apply" mpv

unset CFLAGS CXXFLAGS
[ "$BUILD_DEBUG" != true ] || export CFLAGS="-pipe -O0 -g"
myconf=
case "$label" in
	mingw*)
		myconf="$myconf --disable-terminfo --disable-termcap --disable-termios --disable-lirc --disable-lircc"
		sed -i -r -e 's/if opts\[.execute.\] == True/if "execute" in opts and opts["execute"]/' waftools/checks/generic.py
	;;
esac

waf configure --prefix=/. \
	--enable-static \
	--enable-static-build \
	--disable-manpage-build \
	--disable-pdf-build \
	$myconf
waf build --verbose

cd build
mv mpv.exe mpv_debug.exe
$CTARGET-strip -o mpv.exe mpv_debug.exe
. "$B_SCRIPTS_D/pack/7z" mpv.exe
